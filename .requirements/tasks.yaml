---
version: '3'

run: once

env:
  PIP_OPTS: "--no-input --no-cache-dir --root-user-action=ignore --prefer-binary --upgrade"

tasks:
  default:
    cmds: [task --list]
    silent: true

  all:
    desc: Install all requirements
    deps:
      - ansible
      - ansible-collections
      - ansible-roles
      - mkdocs
      - yamllint
    cmds:
      - task: openssh-client

  ansible:
    desc: Install Ansible
    cmds:
      - pip3 install {{.PIP_OPTS}} -r {{.REQS_FILE}}
    status:
      - python3 -c "import pkg_resources; pkg_resources.require(open('{{.REQS_FILE}}',mode='r'))"
    vars:
      REQS_FILE: ./ansible.requirements.txt

  ansible-roles:
    desc: Install Ansible roles
    deps:
      - ansible
    cmds:
      - ansible-galaxy role install -r ./ansible.requirements.yaml

  ansible-collections:
    desc: Install Ansible collections
    deps:
      - ansible
    cmds:
      - ansible-galaxy collection install -r ./ansible.requirements.yaml

  mkdocs:
    desc: Install mkdocs
    cmds:
      - pip3 install {{.PIP_OPTS}} -r {{.REQS_FILE}}
    status:
      - python3 -c "import pkg_resources; pkg_resources.require(open('{{.REQS_FILE}}',mode='r'))"
    vars:
      REQS_FILE: ./mkdocs.requirements.txt

  openssh-client:
    desc: Install OpenSSH client
    cmds:
      - sudo apt update -y || apt update -y
      - sudo apt install -y openssh-client || apt install -y openssh-client
    status:
      - ssh -V 2>&1 | grep OpenSSH

  yamllint:
    desc: Install yamllint
    cmds:
      - pip3 install {{.PIP_OPTS}} -r {{.REQS_FILE}}
    status:
      - python3 -c "import pkg_resources; pkg_resources.require(open('{{.REQS_FILE}}',mode='r'))"
    vars:
      REQS_FILE: ./yamllint.requirements.txt
